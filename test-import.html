<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridFlow Import Test</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.5.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
</head>
<body class="bg-base-200 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">GridFlow Import Test</h1>
        
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h2 class="card-title">Test Import Compatibility</h2>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Select backup file to test</span>
                    </label>
                    <input type="file" id="testFile" accept=".json" class="file-input file-input-bordered w-full max-w-xs" />
                </div>
                <div class="card-actions justify-end mt-4">
                    <button id="testBtn" class="btn btn-primary">Test Import</button>
                </div>
            </div>
        </div>
        
        <div id="results" class="space-y-4"></div>
    </div>

    <script type="module">
        // Simplified migration logic for testing
        class SimpleMigrator {
            detectVersion(data) {
                if (data.version === '7.0' || data.exportFormat === 'dexie') return '7.0';
                if (data.version === '6.0' || data.exportFormat === 'indexeddb') return '6.0';
                if (data.version === '5.0' || (data.entities && Object.values(data.entities)[0]?.type)) return '5.0';
                if (data.version === '4.0' || data.relationships) return '4.0';
                if (data.version === '3.0' || data.weeklyPlans) return '3.0';
                if (data.version === '2.5' || data.templates) return '2.5';
                if (data.version === '2.0' || data.boards) return '2.0';
                if (data.groups || data.rows) return '1.0';
                return '7.0';
            }
            
            async migrateData(data) {
                return {
                    ...data,
                    version: '7.0',
                    exportFormat: 'dexie',
                    migratedAt: new Date().toISOString()
                };
            }
            
            getMigrationLog() {
                return [
                    { level: 'info', message: 'Migration test completed' },
                    { level: 'success', message: 'Data structure validated' }
                ];
            }
        }
        
        class SimpleValidator {
            validateData(data) {
                const stats = {
                    entities: Object.keys(data.entities || {}).length,
                    boards: Object.keys(data.boards || {}).length,
                    templates: (data.templates || []).length,
                    weeklyPlans: Object.keys(data.weeklyPlans || {}).length,
                    people: (data.people || []).length,
                    tags: (data.tags || []).length,
                    collections: Object.keys(data.collections || {}).length
                };
                
                return {
                    isValid: true,
                    errors: [],
                    warnings: [],
                    fixes: [],
                    stats
                };
            }
        }
        
        const migrator = new SimpleMigrator();
        const validator = new SimpleValidator();
        
        async function testImport() {
            const fileInput = document.getElementById('testFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file first');
                return;
            }
            
            const results = document.getElementById('results');
            results.innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            
            try {
                const content = await file.text();
                const data = JSON.parse(content);
                
                // Detect version
                const detectedVersion = migrator.detectVersion(data);
                
                // Run migration
                const migratedData = await migrator.migrateData(data);
                
                // Validate migrated data
                const validation = validator.validateData(migratedData);
                
                // Get migration log
                const migrationLog = migrator.getMigrationLog();
                
                // Display results
                results.innerHTML = `
                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <h3 class="card-title">Import Test Results</h3>
                            
                            <div class="stats shadow">
                                <div class="stat">
                                    <div class="stat-title">Detected Version</div>
                                    <div class="stat-value text-primary">${detectedVersion}</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-title">Target Version</div>
                                    <div class="stat-value text-secondary">7.0</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-title">Validation</div>
                                    <div class="stat-value ${validation.isValid ? 'text-success' : 'text-error'}">${validation.isValid ? 'PASSED' : 'FAILED'}</div>
                                </div>
                            </div>
                            
                            <div class="divider">Data Statistics</div>
                            <div class="overflow-x-auto">
                                <table class="table table-sm">
                                    <tbody>
                                        ${Object.entries(validation.stats).map(([key, value]) => `
                                            <tr>
                                                <td class="font-medium">${key}</td>
                                                <td>${value}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            ${validation.errors.length > 0 ? `
                                <div class="divider">Errors (${validation.errors.length})</div>
                                <div class="alert alert-error">
                                    <ul class="list-disc list-inside">
                                        ${validation.errors.slice(0, 10).map(err => `<li>${err}</li>`).join('')}
                                        ${validation.errors.length > 10 ? `<li>... and ${validation.errors.length - 10} more</li>` : ''}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${validation.warnings.length > 0 ? `
                                <div class="divider">Warnings (${validation.warnings.length})</div>
                                <div class="alert alert-warning">
                                    <ul class="list-disc list-inside">
                                        ${validation.warnings.slice(0, 10).map(warn => `<li>${warn}</li>`).join('')}
                                        ${validation.warnings.length > 10 ? `<li>... and ${validation.warnings.length - 10} more</li>` : ''}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${validation.fixes.length > 0 ? `
                                <div class="divider">Auto-fixes Applied (${validation.fixes.length})</div>
                                <div class="alert alert-info">
                                    <ul class="list-disc list-inside">
                                        ${validation.fixes.slice(0, 10).map(fix => `<li>${fix}</li>`).join('')}
                                        ${validation.fixes.length > 10 ? `<li>... and ${validation.fixes.length - 10} more</li>` : ''}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="divider">Migration Log</div>
                            <div class="mockup-code max-h-64 overflow-y-auto">
                                ${migrationLog.map(entry => {
                                    const emoji = entry.level === 'error' ? '❌' : 
                                                 entry.level === 'success' ? '✅' : 
                                                 entry.level === 'warning' ? '⚠️' : 'ℹ️';
                                    return `<pre data-prefix="${emoji}"><code>${entry.message}</code></pre>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                results.innerHTML = `
                    <div class="alert alert-error">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>Error: ${error.message}</span>
                    </div>
                `;
            }
        }
        
        // Set up event listener
        document.getElementById('testBtn').addEventListener('click', testImport);
    </script>
</body>
</html>